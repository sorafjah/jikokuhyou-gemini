<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>時刻表問題</title>
    <style>
        :root {
            --text-color: #000000;
            --bg-color: #ffffff;
            --gray-light: #f2f2f2;
            --border-color: #000000;
            --main-btn-color: #00bfff;
        }
        body {
            font-family: "BIZ UDPGothic", "BIZ UDPゴシック", "Yu Gothic", "游ゴシック", sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0; padding: 20px; line-height: 1.6; font-size: 14pt;
        }
        #page-config {
            max-width: 800px; margin: 0 auto; background: #f8f8f8;
            padding: 30px; border-radius: 8px; border: 1px solid #ccc;
        }
        .config-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
        .config-section h3 { margin-top: 0; font-size: 16pt; }
        input[type="number"], select {
            font-size: 1.1em; padding: 5px; margin: 0 5px; font-family: "Arial", sans-serif;
        }
        input[type="number"] { width: 70px; text-align: right; }
        label { display: inline-block; margin-bottom: 10px; cursor: pointer; }
        .checkbox-list label { display: block; margin-bottom: 8px; font-size: 12pt; }
        .create-btn {
            display: block; width: 100%; padding: 15px; font-size: 16pt; font-weight: bold;
            color: #fff; background-color: var(--main-btn-color); border: none; border-radius: 5px; cursor: pointer;
        }
        .create-btn:hover { opacity: 0.8; }

        /* 時間範囲スピナー */
        .hour-spinner { display: inline-flex; align-items: center; gap: 2px; margin: 0 5px; }
        .hour-spinner .hour-val {
            font-size: 1.2em; font-family: "Arial", sans-serif; width: 2.5em; text-align: center;
            border: 1px solid #aaa; border-radius: 4px; padding: 4px 0; background: #fff; user-select: none;
        }
        .hour-spinner .spin-btns { display: flex; flex-direction: column; gap: 1px; }
        .hour-spinner .spin-btns button {
            font-size: 10px; line-height: 1; padding: 2px 6px; cursor: pointer;
            border: 1px solid #aaa; background: #eee; border-radius: 3px; color: #333;
        }
        .hour-spinner .spin-btns button:hover { background: #ddd; }

        #page-print { display: none; }
        .print-container {
            max-width: 800px; margin: 0 auto; border: 1px solid var(--border-color);
            padding: 30px; box-sizing: border-box; background: #fff;
        }
        .action-buttons { text-align: right; margin-bottom: 20px; }
        .action-buttons button {
            font-size: 12pt; padding: 10px 20px; margin-left: 10px; cursor: pointer;
            background-color: var(--main-btn-color); color: #fff; border: none; border-radius: 5px; font-weight: bold;
        }
        .action-buttons button:hover { opacity: 0.8; }
        .copy-toast {
            display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 24px; border-radius: 6px; font-size: 12pt; z-index: 9999;
        }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; font-size: 12pt; }
            @page { size: A4 portrait; margin: 15mm; }
            .print-container { border: none !important; padding: 0 !important; }
        }
        h1 {
            font-size: 18pt; text-align: center; border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px; margin-top: 0; letter-spacing: 2px;
        }
        .name-field { text-align: right; margin-bottom: 10px; font-size: 14pt; }
        .name-field span {
            border-bottom: 1px solid var(--border-color); display: inline-block; width: 200px; height: 1.2em;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; table-layout: fixed; }
        th, td { border: 1px solid var(--border-color); padding: 6px; }
        th {
            font-weight: normal; background-color: var(--gray-light) !important;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        #timetableBody tr:nth-child(even) {
            background-color: var(--gray-light) !important;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        .hour { font-weight: bold; width: 50px; text-align: center; font-size: 1.2em; font-family: "Arial", sans-serif; }
        .minutes { text-align: left; padding-left: 15px; letter-spacing: 5px; font-size: 1.1em; }
        .travel-times { text-align: center; margin-top: 10px; margin-bottom: 30px; font-size: 11pt; }
        .q-list { margin-top: 20px; }
        .q-item {
            margin-bottom: 25px; page-break-inside: avoid; line-height: 2.0;
            display: flex; flex-wrap: wrap; align-items: baseline;
        }
        .q-num { margin-right: 5px; font-family: "Arial", sans-serif; flex-shrink: 0; }
        .q-text { flex: 1 1 auto; }
        .q-ans { margin-left: auto; white-space: nowrap; flex-shrink: 0; }
        .q-ans u { text-decoration-thickness: 1px; text-underline-offset: 4px; letter-spacing: 2px; }
        [contenteditable="true"] { outline: none; border-radius: 3px; transition: background-color 0.2s; }
        [contenteditable="true"]:hover { background-color: #ffffcc; cursor: text; }
        .num-font { font-family: "Arial", sans-serif; }
    </style>
</head>
<body>

<div id="page-config">
    <h1 style="border: none;">問題設定</h1>

    <div class="config-section">
        <h3>1. 時刻表の設定</h3>
        <label>発車時刻：
            <select id="intervalType" style="font-size: 12pt; padding: 5px;">
                <option value="5">5分ごと</option>
                <option value="1">1分ごと</option>
            </select>
        </label>
        <div style="margin-top: 12px;">
            <span>時刻表の範囲：</span>
            <span class="hour-spinner">
                <span class="hour-val" id="rangeStartVal">6</span>
                <span class="spin-btns">
                    <button onclick="spinHour('rangeStart',1)">△</button>
                    <button onclick="spinHour('rangeStart',-1)">▽</button>
                </span>
            </span>時 〜
            <span class="hour-spinner">
                <span class="hour-val" id="rangeEndVal">21</span>
                <span class="spin-btns">
                    <button onclick="spinHour('rangeEnd',1)">△</button>
                    <button onclick="spinHour('rangeEnd',-1)">▽</button>
                </span>
            </span>時　の間からランダムに
            <span class="hour-spinner">
                <span class="hour-val" id="rangeDurVal">8</span>
                <span class="spin-btns">
                    <button onclick="spinHour('rangeDur',1)">△</button>
                    <button onclick="spinHour('rangeDur',-1)">▽</button>
                </span>
            </span>時間分
        </div>
    </div>

    <div class="config-section">
        <h3>2. 問題の条件</h3>
        <label>問題数： <input type="number" id="qCount" value="5" min="1" max="20"> 問</label><br>
        <label>現在時刻（いま○時○分）：
            <select id="baseTimeType" style="font-size: 12pt; padding: 5px;">
                <option value="5">5分ごと</option>
                <option value="1">1分ごと</option>
            </select>
        </label>
        <div class="checkbox-list" style="margin-top: 15px;">
            <label><input type="checkbox" id="type1" checked> 「いま駅にいて、○時○分です。すぐ乗れる電車は何時何分ですか？」</label>
            <label><input type="checkbox" id="type2" checked> 「いま駅にいて、○時○分です。電車はあと何分で来ますか？」</label>
            <label><input type="checkbox" id="type3" checked> 「家を○時○分に出発します。何時何分の電車に乗れますか？」</label>
            <label><input type="checkbox" id="type4" checked> 「○時○分の電車に乗るには、家を何時何分に出発したらいいですか？」</label>
            <label><input type="checkbox" id="type5" checked> 「○時○分の電車に乗ると、〇〇駅に何時何分に着きますか？」</label>
            <label><input type="checkbox" id="type6" checked> 「〇〇駅に○時○分に着くには、何時何分の電車に乗ればいいですか？」</label>
            <label><input type="checkbox" id="type7" checked> 「〇〇駅に○時○分に着くには、家を何時何分に出発したらいいですか？」</label>
        </div>
    </div>

    <div class="config-section">
        <h3>3. 所要時間と時刻の設定</h3>
        <label>家から駅まで：
            <select id="homeToStationType" style="font-size: 12pt; padding: 5px;">
                <option value="5">5分ごと</option>
                <option value="1">1分ごと</option>
            </select>
        </label><br>
        <label style="margin-top: 10px;">駅から目的駅まで：
            <select id="stationToDestType" style="font-size: 12pt; padding: 5px;">
                <option value="5">5分ごと</option>
                <option value="1">1分ごと</option>
            </select>
        </label>
    </div>

    <button class="create-btn" onclick="buildAndShow()">問題を作成する</button>
</div>

<div id="page-print">
    <div class="no-print action-buttons">
        <button onclick="showConfig()">設定に戻る</button>
        <button onclick="window.print()">このまま印刷する</button>
        <button onclick="copyHTML()">HTMLをコピーする</button>
    </div>
    <div id="copyToast" class="copy-toast">コピーしました！</div>

    <div class="print-container" id="printContainer">
        <div class="name-field"><ruby>名前<rt>なまえ</rt></ruby>：<span></span></div>
        <p contenteditable="true"><ruby>次<rt>つぎ</rt></ruby>の<ruby>時刻表<rt>じこくひょう</rt></ruby>を<ruby>見<rt>み</rt></ruby>て、<ruby>下<rt>した</rt></ruby>の<ruby>問題<rt>もんだい</rt></ruby>に<ruby>答<rt>こた</rt></ruby>えましょう。</p>

        <table id="timetable" contenteditable="true">
            <thead>
                <tr>
                    <th class="hour"><ruby>時<rt>じ</rt></ruby></th>
                    <th class="minutes" style="padding: 0;">
                        <div style="display: flex; align-items: center; padding: 6px 15px;">
                            <span><ruby>分<rt>ふん</rt></ruby></span>
                            <span style="flex-grow: 1; text-align: center;">（<span id="displayDest"></span> <ruby>行<rt>ゆ</rt></ruby>き）</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody id="timetableBody"></tbody>
        </table>

        <div class="travel-times" id="travelTimesDisplay" contenteditable="true"></div>
        <div class="q-list" id="questionList" contenteditable="true"></div>
    </div>
</div>

<script>
let currentTimetable = {};
let tableStartHour = 6;
let tableEndHour = 13;

// スピナーの状態
let rangeStart = 6, rangeEnd = 21, rangeDur = 8;

function padZero(n) { return n.toString().padStart(2, '0'); }
function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function spinHour(which, delta) {
    if (which === 'rangeStart') {
        rangeStart = Math.max(0, Math.min(23, rangeStart + delta));
        if (rangeEnd <= rangeStart) rangeEnd = Math.min(24, rangeStart + 1);
        if (rangeDur > rangeEnd - rangeStart) rangeDur = Math.max(1, rangeEnd - rangeStart);
    } else if (which === 'rangeEnd') {
        rangeEnd = Math.max(1, Math.min(24, rangeEnd + delta));
        if (rangeStart >= rangeEnd) rangeStart = Math.max(0, rangeEnd - 1);
        if (rangeDur > rangeEnd - rangeStart) rangeDur = Math.max(1, rangeEnd - rangeStart);
    } else if (which === 'rangeDur') {
        rangeDur = Math.max(1, Math.min(rangeEnd - rangeStart, rangeDur + delta));
    }
    document.getElementById('rangeStartVal').textContent = rangeStart;
    document.getElementById('rangeEndVal').textContent = rangeEnd;
    document.getElementById('rangeDurVal').textContent = rangeDur;
}

function showConfig() {
    document.getElementById('page-config').style.display = 'block';
    document.getElementById('page-print').style.display = 'none';
}
function buildAndShow() {
    if (!generateProblem()) return;
    document.getElementById('page-config').style.display = 'none';
    document.getElementById('page-print').style.display = 'block';
}

function copyHTML() {
    var el = document.getElementById('printContainer');
    var html = el.innerHTML;
    // contenteditable属性を除去
    html = html.replace(/\s*contenteditable="true"/g, '');
    navigator.clipboard.writeText(html).then(function() {
        var toast = document.getElementById('copyToast');
        toast.style.display = 'block';
        setTimeout(function() { toast.style.display = 'none'; }, 1500);
    });
}

function generateTimetable(isRandomMins) {
    var body = document.getElementById('timetableBody');
    body.innerHTML = '';
    currentTimetable = {};

    var counts = {
        0:3, 1:2, 2:2, 3:2, 4:3, 5:4, 6:6, 7:8, 8:7, 9:5, 10:4, 11:4, 12:4,
        13:4, 14:4, 15:5, 16:6, 17:7, 18:8, 19:7, 20:6, 21:5, 22:4, 23:3
    };

    var span = rangeEnd - rangeStart;
    var dur = rangeDur;
    var maxStart = rangeEnd - dur;
    tableStartHour = getRandomInt(rangeStart, maxStart);
    tableEndHour = tableStartHour + dur - 1;

    for (var h = tableStartHour; h <= tableEndHour; h++) {
        var mins = [];
        var count = counts[h] || 4;

        if (isRandomMins) {
            while (mins.length < count) {
                var m = getRandomInt(0, 59);
                if (mins.indexOf(m) === -1) mins.push(m);
            }
            mins.sort(function(a,b){return a-b;});
        } else {
            var step = Math.floor(60 / count);
            for (var i = 0; i < count; i++) {
                var m = i * step;
                if (count === 8) m = i * 7;
                if (count === 7) m = i * 8;
                m = Math.round(m / 5) * 5;
                if (m >= 60) m = 55;
                if (mins.indexOf(m) === -1) mins.push(m);
            }
            while (mins.length < count) {
                var m = getRandomInt(0, 11) * 5;
                if (mins.indexOf(m) === -1) mins.push(m);
            }
            mins.sort(function(a,b){return a-b;});
        }
        currentTimetable[h] = mins;
        var tr = document.createElement('tr');
        var minStr = mins.map(function(m){ return '<span class="num-font">' + padZero(m) + '</span>'; }).join('　');
        tr.innerHTML = '<td class="hour">' + h + '</td><td class="minutes">' + minStr + '</td>';
        body.appendChild(tr);
    }
}

function generateProblem() {
    var qCount = parseInt(document.getElementById('qCount').value, 10);
    var homeToStation = 0;
    if (document.getElementById('homeToStationType').value === '5') {
        homeToStation = getRandomInt(1, 6) * 5;
    } else {
        homeToStation = getRandomInt(5, 30);
    }
    var stationToDest = 0;
    if (document.getElementById('stationToDestType').value === '5') {
        stationToDest = getRandomInt(2, 9) * 5;
    } else {
        stationToDest = getRandomInt(10, 50);
    }
    var dests = [
        {name:"青空",ruby:"あおぞら"},{name:"希望",ruby:"きぼう"},{name:"未来",ruby:"みらい"},
        {name:"桜町",ruby:"さくらまち"},{name:"朝日",ruby:"あさひ"}
    ];
    var selectedDest = dests[getRandomInt(0, dests.length - 1)];
    var destName = selectedDest.name, destRuby = selectedDest.ruby;
    var isIntervalRandom = document.getElementById('intervalType').value === '1';

    var activeTypes = [];
    for (var i = 1; i <= 7; i++) {
        if (document.getElementById('type' + i).checked) activeTypes.push(i);
    }
    if (activeTypes.length === 0) { alert("問題の種類を少なくとも1つ選んでください。"); return false; }

    generateTimetable(isIntervalRandom);
    document.getElementById('displayDest').innerHTML = '<ruby>' + destName + '<rt>' + destRuby + '</rt></ruby>';
    document.getElementById('travelTimesDisplay').innerHTML =
        '（<ruby>家<rt>いえ</rt></ruby>から<ruby>近<rt>ちか</rt></ruby>くの<ruby>駅<rt>えき</rt></ruby>まで <span class="num-font">' + homeToStation + '</span> <ruby>分<rt>ふん</rt></ruby>、<ruby>近<rt>ちか</rt></ruby>くの<ruby>駅<rt>えき</rt></ruby>から<ruby>' + destName + '<rt>' + destRuby + '</rt></ruby><ruby>駅<rt>えき</rt></ruby>まで <span class="num-font">' + stationToDest + '</span> <ruby>分<rt>ふん</rt></ruby>）';

    var timetableAbs = [];
    for (var h in currentTimetable) {
        currentTimetable[h].forEach(function(m){ timetableAbs.push(parseInt(h)*60+m); });
    }
    timetableAbs.sort(function(a,b){return a-b;});
    var lastTrainMin = timetableAbs[timetableAbs.length - 1];

    var qList = document.getElementById('questionList');
    qList.innerHTML = '';
    var isBaseTime5Min = document.getElementById('baseTimeType').value === '5';

    for (var i = 0; i < qCount; i++) {
        var type = activeTypes[Math.floor(Math.random() * activeTypes.length)];
        var qText = "";
        var ansText = '<u>　　　　　　　　　　</u>';
        var baseMin = getRandomInt(tableStartHour * 60, lastTrainMin - 1);
        if (isBaseTime5Min) baseMin = Math.round(baseMin / 5) * 5;

        if (type === 1) {
            var bH = Math.floor(baseMin/60), bM = baseMin%60;
            qText = 'いま<ruby>駅<rt>えき</rt></ruby>にいて、<span class="num-font">'+bH+'</span><ruby>時<rt>じ</rt></ruby><span class="num-font">'+bM+'</span><ruby>分<rt>ふん</rt></ruby>です。すぐ<ruby>乗<rt>の</rt></ruby>れる<ruby>電車<rt>でんしゃ</rt></ruby>は<ruby>何時何分<rt>なんじなんぷん</rt></ruby>ですか。';
        } else if (type === 2) {
            var bH = Math.floor(baseMin/60), bM = baseMin%60;
            qText = 'いま<ruby>駅<rt>えき</rt></ruby>にいて、<span class="num-font">'+bH+'</span><ruby>時<rt>じ</rt></ruby><span class="num-font">'+bM+'</span><ruby>分<rt>ふん</rt></ruby>です。<ruby>電車<rt>でんしゃ</rt></ruby>はあと<ruby>何分<rt>なんぷん</rt></ruby>で<ruby>来<rt>き</rt></ruby>ますか。';
        } else if (type === 3) {
            var arrivalAtStation = baseMin + homeToStation;
            var trainMin = null;
            for(var j=0;j<timetableAbs.length;j++){if(timetableAbs[j]>=arrivalAtStation){trainMin=timetableAbs[j];break;}}
            if (!trainMin) { baseMin = lastTrainMin - homeToStation - 15; if(isBaseTime5Min) baseMin = Math.round(baseMin/5)*5; }
            var bH = Math.floor(baseMin/60), bM = baseMin%60;
            qText = '<ruby>家<rt>いえ</rt></ruby>を<span class="num-font">'+bH+'</span><ruby>時<rt>じ</rt></ruby><span class="num-font">'+bM+'</span><ruby>分<rt>ふん</rt></ruby>に<ruby>出発<rt>しゅっぱつ</rt></ruby>します。<ruby>何時何分<rt>なんじなんぷん</rt></ruby>の<ruby>電車<rt>でんしゃ</rt></ruby>に<ruby>乗<rt>の</rt></ruby>れますか。';
        } else if (type === 4) {
            var trainMin = timetableAbs[getRandomInt(0, timetableAbs.length-1)];
            var tH = Math.floor(trainMin/60), tM = trainMin%60;
            qText = '<span class="num-font">'+tH+'</span><ruby>時<rt>じ</rt></ruby><span class="num-font">'+tM+'</span><ruby>分<rt>ふん</rt></ruby>の<ruby>電車<rt>でんしゃ</rt></ruby>に<ruby>乗<rt>の</rt></ruby>るには、<ruby>家<rt>いえ</rt></ruby>を<ruby>何時何分<rt>なんじなんぷん</rt></ruby>に<ruby>出発<rt>しゅっぱつ</rt></ruby>したらいいですか。';
        } else if (type === 5) {
            var trainMin = timetableAbs[getRandomInt(0, timetableAbs.length-1)];
            var tH = Math.floor(trainMin/60), tM = trainMin%60;
            qText = '<span class="num-font">'+tH+'</span><ruby>時<rt>じ</rt></ruby><span class="num-font">'+tM+'</span><ruby>分<rt>ふん</rt></ruby>の<ruby>電車<rt>でんしゃ</rt></ruby>に<ruby>乗<rt>の</rt></ruby>ると、<ruby>'+destName+'<rt>'+destRuby+'</rt></ruby><ruby>駅<rt>えき</rt></ruby>には<ruby>何時何分<rt>なんじなんぷん</rt></ruby>に<ruby>着<rt>つ</rt></ruby>きますか。';
        } else if (type === 6) {
            var trainMin = timetableAbs[getRandomInt(0, timetableAbs.length-1)];
            var destAbs = trainMin + stationToDest;
            var dH = Math.floor(destAbs/60), dM = destAbs%60;
            qText = '<ruby>'+destName+'<rt>'+destRuby+'</rt></ruby><ruby>駅<rt>えき</rt></ruby>に<span class="num-font">'+dH+'</span><ruby>時<rt>じ</rt></ruby><span class="num-font">'+dM+'</span><ruby>分<rt>ふん</rt></ruby>に<ruby>着<rt>つ</rt></ruby>くには、<ruby>何時何分<rt>なんじなんぷん</rt></ruby>の<ruby>電車<rt>でんしゃ</rt></ruby>に<ruby>乗<rt>の</rt></ruby>ればいいですか。';
        } else if (type === 7) {
            var trainMin = timetableAbs[getRandomInt(0, timetableAbs.length-1)];
            var destAbs = trainMin + stationToDest;
            var dH = Math.floor(destAbs/60), dM = destAbs%60;
            qText = '<ruby>'+destName+'<rt>'+destRuby+'</rt></ruby><ruby>駅<rt>えき</rt></ruby>に<span class="num-font">'+dH+'</span><ruby>時<rt>じ</rt></ruby><span class="num-font">'+dM+'</span><ruby>分<rt>ふん</rt></ruby>に<ruby>着<rt>つ</rt></ruby>くには、<ruby>家<rt>いえ</rt></ruby>を<ruby>何時何分<rt>なんじなんぷん</rt></ruby>に<ruby>出発<rt>しゅっぱつ</rt></ruby>したらいいですか。';
        }

        var div = document.createElement('div');
        div.className = 'q-item';
        div.innerHTML = '<span class="q-num">(' + (i+1) + ')</span> <span class="q-text">' + qText + '</span> <span class="q-ans">' + ansText + '</span>';
        qList.appendChild(div);
    }
    return true;
}
</script>
</body>
</html>
